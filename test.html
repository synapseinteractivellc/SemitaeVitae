<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semitae Vitae - Task System Test</title>
    <link rel="stylesheet" href="./css/main.css" />
    <style>
        /* Additional test-specific styles */
        .debug-panel {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            height: 200px;
            overflow: auto;
        }
        
        .debug-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .debug-actions {
            margin-top: 10px;
        }
        
        .debug-button {
            padding: 5px 10px;
            background-color: #3a7bd5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-right">
            <button id="test-button" class="header-button"><a href="./test.html">Test</a></button>
            <button id="simple-test-button" class="header-button"><a href="./simpleTest.html">Simple Test</a></button>
            <button id="home-button" class="header-button"><a href="./index.html">Home</a></button>
            <button id="save-button" class="header-button">Save</button>
            <button id="wipe-button" class="header-button">Wipe</button>
        </div>
        <div class="header-content">
            <h1>Semitae Vitae - Task System Test</h1>
            <p id="character-info">Testing Task System</p>
        </div>
    </header>

    <!-- Content area -->
    <div class="content-area">
        <!-- Game page where all the fun takes place -->
        <section id="game-page" style="display:grid">
            <div class="main-panel">
                <div id="resource-panel">
                    <h3>Resources</h3>
                </div>
                <div id="game-panel">
                    <h2>Game Content</h2>
                </div>
                <div id="stats-panel">
                    <h3>Stats</h3>
                </div>
                <div id="action-log">
                    <h3>Action Log</h3>
                </div>
            </div>
            <!-- Debug Panel -->
            <div class="debug-panel">
                <div class="debug-title">Debug Panel</div>
                <div class="debug-actions">
                    <button id="debug-add-gold" class="debug-button">Add Gold</button>
                    <button id="debug-add-stamina" class="debug-button">Add Stamina</button>
                    <button id="debug-add-wood-axe" class="debug-button">Add Wood Axe</button>
                    <button id="debug-add-hunting-kit" class="debug-button">Add Hunting Kit</button>
                </div>
                <div id="debug-output"></div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Licensed under the <a href="https://opensource.org/licenses/MIT" target="_blank" rel="noopener">MIT License</a>.<br>
        Semitae Vitae © 2025 <a href="https://github.com/synapseinteractivellc/SemitaeVitae" target="_blank" rel="noopener">Synapse Interactive LLC</a>.</p>
    </footer>

    <script type="module">
        import { Character } from './js/models/Character.js';
        import { TaskManager } from './js/managers/TaskManager.js';
        
        // Load game data and initialize test environment
        async function initTestEnvironment() {
            // Load resources
            const resourceResponse = await fetch('./data/resources.json');
            const resourceDefinitions = await resourceResponse.json();
            
            // Load tasks
            const taskResponse = await fetch('./data/tasks.json');
            const taskDefinitions = await taskResponse.json();
            
            // Load upgrades
            const upgradeResponse = await fetch('./data/upgrades.json');
            const upgradeDefinitions = await upgradeResponse.json();
            
            // Create a test game object
            window.testGame = {
                resourceDefinitions,
                taskDefinitions,
                upgradeDefinitions,
                updateUI: () => {
                    updateResourcePanel();
                    updateStatsPanel();
                    updateGamePanel();
                },
                addToActionLog: (message) => {
                    const actionLog = document.getElementById('action-log');
                    let logEntries = actionLog.querySelector('.log-entries');
                    if (!logEntries) {
                        actionLog.innerHTML = '<h3>Action Log</h3><div class="log-entries"></div>';
                        logEntries = actionLog.querySelector('.log-entries');
                    }
                    
                    const logEntry = document.createElement('p');
                    logEntry.textContent = message;
                    logEntries.appendChild(logEntry);
                    
                    // Auto-scroll to the bottom
                    logEntries.scrollTop = logEntries.scrollHeight;
                },
                capitalizeFirstLetter: (string) => {
                    if (!string) return '';
                    return string.charAt(0).toUpperCase() + string.slice(1);
                },
                saveGame: () => {
                    localStorage.setItem('semitaeVitae_testPlayer', JSON.stringify(window.testGame.player));
                    console.log('Game saved');
                },
                startGameTick: () => {
                    if (!window.testGame.gameTickInterval) {
                        window.testGame.lastTick = Date.now();
                        window.testGame.gameTickInterval = setInterval(() => updateGameTick(), 100);
                    }
                },
                stopGameTick: () => {
                    if (window.testGame.gameTickInterval) {
                        clearInterval(window.testGame.gameTickInterval);
                        window.testGame.gameTickInterval = null;
                    }
                }
            };
            
            // Create or load player
            const savedPlayer = localStorage.getItem('semitaeVitae_testPlayer');
            if (savedPlayer) {
                window.testGame.player = new Character(JSON.parse(savedPlayer));
                console.log('Loaded saved player');
            } else {
                window.testGame.player = new Character({ name: 'Test Player' });
                
                // Initialize resources
                resourceDefinitions.forEach(resourceDef => {
                    window.testGame.player.initResource(resourceDef);
                });
                
                // Initialize starting resources
                window.testGame.player.resources['hp'].locked = false;
                window.testGame.player.resources['hp'].value = window.testGame.player.resources['hp'].max;
                window.testGame.player.resources['stamina'].locked = false;
                window.testGame.player.resources['stamina'].value = window.testGame.player.resources['stamina'].max;
                window.testGame.player.resources['gold'].locked = false;
                window.testGame.player.resources['gold'].value = 5;
                
                // Initialize upgrades
                window.testGame.player.upgrades = {};
                
                console.log('Created new test player');
            }
            
            // Initialize task manager
            window.testGame.taskManager = new TaskManager(window.testGame);
            
            // Initialize UI
            initUI();
            
            // Start game tick
            window.testGame.startGameTick();
            
            // Set up debug buttons
            document.getElementById('debug-add-gold').addEventListener('click', () => {
                window.testGame.player.addResource('gold', 10);
                window.testGame.updateUI();
                window.testGame.addToActionLog('Added 10 gold (debug)');
            });
            
            document.getElementById('debug-add-stamina').addEventListener('click', () => {
                window.testGame.player.addResource('stamina', 5);
                window.testGame.updateUI();
                window.testGame.addToActionLog('Added 5 stamina (debug)');
            });
            
            document.getElementById('debug-add-wood-axe').addEventListener('click', () => {
                if (!window.testGame.player.upgrades) {
                    window.testGame.player.upgrades = {};
                }
                window.testGame.player.upgrades['woodax'] = 1;
                window.testGame.updateUI();
                window.testGame.addToActionLog('Added Wood Axe upgrade (debug)');
            });
            
            document.getElementById('debug-add-hunting-kit').addEventListener('click', () => {
                if (!window.testGame.player.upgrades) {
                    window.testGame.player.upgrades = {};
                }
                window.testGame.player.upgrades['huntingkit'] = 1;
                window.testGame.updateUI();
                window.testGame.addToActionLog('Added Hunting Kit upgrade (debug)');
            });
            
            // Set up save and wipe buttons
            document.getElementById('save-button').addEventListener('click', () => {
                window.testGame.saveGame();
                window.testGame.addToActionLog('Game saved.');
            });
            
            document.getElementById('wipe-button').addEventListener('click', () => {
                if (confirm('Are you sure you want to wipe all saved data? This cannot be undone.')) {
                    localStorage.removeItem('semitaeVitae_testPlayer');
                    window.testGame.addToActionLog('Game data wiped.');
                    location.reload(); // Reload the page to start fresh
                }
            });
            
            console.log('Test environment initialized');
        }
        
        // Initialize UI elements
        function initUI() {
            initResourcePanel();
            initStatsPanel();
            initGamePanel();
        }
        
        // Update game tick
        function updateGameTick() {
            const now = Date.now();
            const deltaTime = now - window.testGame.lastTick;
            window.testGame.lastTick = now;
            
            // Process task updates
            if (window.testGame.taskManager) {
                window.testGame.taskManager.processTick(deltaTime);
            }
            
            // Update UI
            window.testGame.updateUI();
        }
        
        // Initialize resource panel
        function initResourcePanel() {
            // Get all resource groups
            const groups = [...new Set(
                window.testGame.player.getUnlockedResources()
                    .filter(r => r.sortOrder < 705)
                    .map(r => r.group)
            )];
            
            let html = '<h3>Resources</h3>';
            
            // Generate HTML for each group
            groups.forEach(group => {
                const groupResources = window.testGame.player.getResourcesByGroup(group)
                    .filter(r => !r.locked && r.sortOrder < 705);
                
                if (groupResources.length === 0) return;
                
                // Create collapsible group
                html += `
                    <div class="resource-group">
                        <div class="group-header" data-group="${group}">
                            <span class="collapse-icon">▼</span> ${capitalizeFirstLetter(group)}
                        </div>
                        <div class="group-content" id="group-${group}">
                `;
                
                // Add resources in this group
                groupResources.forEach(resource => {
                    let resourceDisplayName = capitalizeFirstLetter(resource.name) || capitalizeFirstLetter(resource.id);
                    html += `
                        <div class="resource" id="resource-${resource.id}">
                            <span class="resource-name" title="${resource.desc || ''}">${resourceDisplayName}:</span>
                            <span class="resource-value">${Math.floor(resource.value)}/${resource.max > 0 ? resource.max : '∞'}</span>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('resource-panel').innerHTML = html;
            
            // Add event listeners for collapsible groups
            document.querySelectorAll('.group-header').forEach(header => {
                header.addEventListener('click', () => {
                    const group = header.getAttribute('data-group');
                    const content = document.getElementById(`group-${group}`);
                    const icon = header.querySelector('.collapse-icon');
                    
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        icon.textContent = '▼';
                    } else {
                        content.style.display = 'none';
                        icon.textContent = '►';
                    }
                });
            });
        }
        
        // Initialize stats panel
        function initStatsPanel() {
            let html = '';
            
            // Add current action display
            html += `
                <div class="current-action">
                    <span class="action-name">Current Task: Idle</span>
                    <div class="progress-bar">
                        <div class="progress" style="width: 0%"></div>
                    </div>
                </div>
            `;
            
            // Get all unlocked stat resources (sortOrder >= 705)
            const statResources = window.testGame.player.getUnlockedStatResources();
            
            // Add each stat resource as a progress bar
            statResources.forEach(resource => {
                const percentage = resource.max > 0 ? (resource.value / resource.max) * 100 : 0;
                const colorClass = getResourceColorClass(resource.id);
                let statName = capitalizeFirstLetter(resource.name) || capitalizeFirstLetter(resource.id);
                
                html += `
                    <div class="stat-resource" id="stat-${resource.id}">
                        <div class="stat-row">
                            <span class="stat-name">${statName}:</span>
                            <div class="stat-bar-container">
                                <div class="stat-bar ${colorClass}" style="width: ${percentage}%"></div>
                                <span class="stat-value">${Math.floor(resource.value)}/${resource.max}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('stats-panel').innerHTML = html;
        }
        
        // Initialize game panel
        function initGamePanel() {
            let html = `<h2>Available Tasks</h2>            
                <div class="action-buttons">
            `;
            
            // Get all available tasks
            const availableTasks = getAvailableTasks();
    
            if (availableTasks.length === 0) {
                html += `<p>No tasks available. Grow your skills.</p>`;
                html += `</div>`;
                document.getElementById('game-panel').innerHTML = html;
                return;
            }
            
            // Group tasks by their group property
            const taskGroups = groupTasksByProperty(availableTasks, 'group');
            
            // Generate HTML for each task group
            Object.entries(taskGroups).forEach(([group, tasks]) => {
                html += `
                    <div class="task-group">
                        <div class="task-group-header" data-group="${group}">
                            <span class="collapse-icon">▼</span> ${capitalizeFirstLetter(group)}
                        </div>
                        <div class="task-group-content" id="task-group-${group}">
                `;
                
                // Add buttons for each task
                tasks.forEach(task => {
                    const isDisabled = !window.testGame.taskManager.canStartTask(task);
                    const buttonClass = isDisabled ? 'task-button disabled' : 'task-button';
                    let taskDisplayName = capitalizeFirstLetter(task.name) || capitalizeFirstLetter(task.id);
                    
                    html += `
                        <button class="${buttonClass}" 
                                data-task-id="${task.id}" 
                                title="${task.desc || ''}"
                                ${isDisabled ? 'disabled' : ''}>
                            ${taskDisplayName}
                        </button>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            document.getElementById('game-panel').innerHTML = html;
            
            // Add event listeners for task buttons
            document.querySelectorAll('.task-button').forEach(button => {
                button.addEventListener('click', () => {
                    const taskId = button.getAttribute('data-task-id');
                    window.testGame.taskManager.startTask(taskId);
                });
            });
            
            // Add event listeners for collapsible task groups
            document.querySelectorAll('.task-group-header').forEach(header => {
                header.addEventListener('click', () => {
                    const group = header.getAttribute('data-group');
                    const content = document.getElementById(`task-group-${group}`);
                    const icon = header.querySelector('.collapse-icon');
                    
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        icon.textContent = '▼';
                    } else {
                        content.style.display = 'none';
                        icon.textContent = '►';
                    }
                });
            });
        }
        
        // Update resource panel
        function updateResourcePanel() {
            // Update each resource value display
            Object.values(window.testGame.player.resources)
                .filter(r => !r.locked && r.sortOrder < 705)
                .forEach(resource => {
                    const element = document.getElementById(`resource-${resource.id}`);
                    if (element) {
                        const valueElement = element.querySelector('.resource-value');
                        if (valueElement) {
                            valueElement.textContent = `${Math.floor(resource.value)}/${resource.max > 0 ? resource.max : '∞'}`;
                        }
                    }
                });
        }
        
        // Update stats panel
        function updateStatsPanel() {
            // Update current action progress
            const actionNameElement = document.querySelector('.action-name');
            const progressElement = document.querySelector('.progress');
            
            if (window.testGame.player.currentAction) {
                const task = window.testGame.player.currentAction;
                const progress = window.testGame.player.currentActionProgress * 100;
                let taskDisplayName = capitalizeFirstLetter(task.verb || task.name || task.id);
                
                actionNameElement.textContent = 'Current Task: ' + taskDisplayName;
                progressElement.style.width = `${progress}%`;
            } else {
                actionNameElement.textContent = 'Current Task: Idle';
                progressElement.style.width = '0%';
            }
            
            // Update stat resources
            window.testGame.player.getUnlockedStatResources().forEach(resource => {
                const element = document.getElementById(`stat-${resource.id}`);
                if (element) {
                    const barElement = element.querySelector('.stat-bar');
                    const valueElement = element.querySelector('.stat-value');
                    
                    if (barElement && valueElement) {
                        const percentage = resource.max > 0 ? (resource.value / resource.max) * 100 : 0;
                        barElement.style.width = `${percentage}%`;
                        valueElement.textContent = `${Math.floor(resource.value)}/${resource.max}`;
                    }
                }
            });
        }
        
        // Update game panel
        function updateGamePanel() {
            // Update task button disabled states
            document.querySelectorAll('.task-button').forEach(button => {
                const taskId = button.getAttribute('data-task-id');
                const task = window.testGame.taskDefinitions.find(t => t.id === taskId);
                
                if (task) {
                    const canExecute = window.testGame.taskManager.canStartTask(task);
                    button.disabled = !canExecute;
                    button.classList.toggle('disabled', !canExecute);
                }
            });
        }
        
        // Get available tasks
        function getAvailableTasks() {
            return window.testGame.taskDefinitions.filter(task => task.locked !== true);
        }
        
        // Group array by property
        function groupTasksByProperty(array, property) {
            return array.reduce((grouped, item) => {
                const key = item[property] || 'misc';
                if (!grouped[key]) {
                    grouped[key] = [];
                }
                grouped[key].push(item);
                return grouped;
            }, {});
        }
        
        // Get resource color class
        function getResourceColorClass(resourceId) {
            switch (resourceId) {
                case 'hp': return 'resource-red';
                case 'stamina': return 'resource-green';
                case 'rage': return 'resource-orange';
                case 'focus': return 'resource-blue';
                case 'mana': return 'resource-purple';
                case 'air': return 'resource-cyan';
                case 'earth': return 'resource-brown';
                case 'fire': return 'resource-red';
                case 'water': return 'resource-blue';
                default: return '';
            }
        }
        
        // Helper function to capitalize the first letter of a string
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Initialize test environment when page loads
        document.addEventListener('DOMContentLoaded', initTestEnvironment);
    </script>
</body>
</html>