<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Upgrade Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .panel {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        h2 {
            margin-top: 0;
        }
        
        .resources div {
            margin-bottom: 5px;
        }
        
        button {
            padding: 8px 12px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .upgrade-button {
            background-color: #9775fa;
        }
        
        .upgrade-button:hover {
            background-color: #7950f2;
        }
        
        .log {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: white;
        }
        
        .log p {
            margin: 3px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <button id="test-button" class="header-button"><a href="./test.html">Test</a></button>
    <button id="simple-test-button" class="header-button"><a href="./simpleTest.html">Simple Test</a></button>
    <button id="home-button" class="header-button"><a href="./index.html">Home</a></button>
    <h1>Simple Upgrade Test</h1>
    
    <div class="panel">
        <h2>Resources</h2>
        <div class="resources" id="resources-display"></div>
    </div>
    
    <div class="panel">
        <h2>Debug Actions</h2>
        <button id="add-gold">Add 10 Gold</button>
        <button id="add-wood">Add 10 Wood</button>
        <button id="add-leather">Add 10 Leather</button>
        <button id="add-gems">Add 5 Gems</button>
    </div>
    
    <div class="panel">
        <h2>Upgrades</h2>
        <div id="upgrades-display"></div>
    </div>
    
    <div class="panel">
        <h2>Action Log</h2>
        <div class="log" id="action-log"></div>
    </div>
    
    <script>
        // Simple game data
        const resources = {
            gold: { id: 'gold', name: 'Gold', value: 5, max: 5 },
            wood: { id: 'wood', name: 'Wood', value: 0, max: 10 },
            leather: { id: 'leather', name: 'Leather', value: 0, max: 10 },
            gems: { id: 'gems', name: 'Gems', value: 0, max: 5 }
        };
        
        const upgrades = [
            {
                id: 'pouch',
                name: 'Money Pouch',
                desc: 'Keep your money safe.',
                max: 3,
                cost: { gold: 5 },
                mod: { 'gold.max': 10 },
                group: 'storage'
            },
            {
                id: 'purse',
                name: 'Coin Purse',
                desc: 'Common way to carry coins.',
                require: 'resources.gold>=20',
                max: 2,
                cost: { gold: 15 },
                mod: { 'gold.max': 20 },
                group: 'storage'
            },
            {
                id: 'woodax',
                name: 'Wood Axe',
                desc: 'An ax for chopping down trees.',
                require: 'resources.gold>=10',
                max: 1,
                cost: { gold: 10 },
                group: 'tools'
            }
        ];
        
        // Track upgrade levels
        const upgradeLevels = {};
        
        // Initialize the UI
        function init() {
            updateResourceDisplay();
            updateUpgradeDisplay();
            
            // Set up debug buttons
            document.getElementById('add-gold').addEventListener('click', () => {
                addResource('gold', 10);
                addToLog('Added 10 gold.');
            });
            
            document.getElementById('add-wood').addEventListener('click', () => {
                addResource('wood', 10);
                addToLog('Added 10 wood.');
            });
            
            document.getElementById('add-leather').addEventListener('click', () => {
                addResource('leather', 10);
                addToLog('Added 10 leather.');
            });
            
            document.getElementById('add-gems').addEventListener('click', () => {
                addResource('gems', 5);
                addToLog('Added 5 gems.');
            });
        }
        
        // Update resource display
        function updateResourceDisplay() {
            const container = document.getElementById('resources-display');
            container.innerHTML = '';
            
            Object.values(resources).forEach(resource => {
                const div = document.createElement('div');
                div.textContent = `${resource.name}: ${resource.value}/${resource.max}`;
                container.appendChild(div);
            });
        }
        
        // Update upgrade display
        function updateUpgradeDisplay() {
            const container = document.getElementById('upgrades-display');
            container.innerHTML = '';
            
            // Group upgrades
            const groups = {};
            upgrades.forEach(upgrade => {
                const group = upgrade.group || 'misc';
                if (!groups[group]) {
                    groups[group] = [];
                }
                groups[group].push(upgrade);
            });
            
            // Create buttons for each group
            Object.entries(groups).forEach(([group, groupUpgrades]) => {
                const groupHeading = document.createElement('h3');
                groupHeading.textContent = capitalize(group);
                container.appendChild(groupHeading);
                
                groupUpgrades.forEach(upgrade => {
                    const level = upgradeLevels[upgrade.id] || 0;
                    
                    // Skip if at max level
                    if (upgrade.max && level >= upgrade.max) {
                        return;
                    }
                    
                    // Check requirements
                    let canPurchase = true;
                    if (upgrade.require) {
                        canPurchase = checkRequirement(upgrade.require);
                    }
                    
                    // Check costs
                    if (canPurchase && upgrade.cost) {
                        for (const [resourceId, amount] of Object.entries(upgrade.cost)) {
                            if (!resources[resourceId] || resources[resourceId].value < amount) {
                                canPurchase = false;
                                break;
                            }
                        }
                    }
                    
                    // Create button
                    const button = document.createElement('button');
                    button.className = 'upgrade-button';
                    button.textContent = upgrade.name;
                    if (level > 0) {
                        button.textContent += ` (${level}/${upgrade.max || 1})`;
                    }
                    button.disabled = !canPurchase;
                    
                    // Add tooltip
                    let tooltip = upgrade.desc || '';
                    if (upgrade.cost) {
                        tooltip += '\nCost: ';
                        for (const [resourceId, amount] of Object.entries(upgrade.cost)) {
                            tooltip += `${amount} ${resourceId}, `;
                        }
                        tooltip = tooltip.slice(0, -2);
                    }
                    button.title = tooltip;
                    
                    // Add click handler
                    button.addEventListener('click', () => {
                        purchaseUpgrade(upgrade);
                    });
                    
                    container.appendChild(button);
                });
            });
        }
        
        // Purchase an upgrade
        function purchaseUpgrade(upgrade) {
            // Apply costs
            if (upgrade.cost) {
                for (const [resourceId, amount] of Object.entries(upgrade.cost)) {
                    if (!subtractResource(resourceId, amount)) {
                        console.error(`Failed to subtract ${amount} ${resourceId}.`);
                        return;
                    }
                }
            }
            
            // Increment level
            upgradeLevels[upgrade.id] = (upgradeLevels[upgrade.id] || 0) + 1;
            
            // Apply effects
            if (upgrade.mod) {
                for (const [resourcePath, modifier] of Object.entries(upgrade.mod)) {
                    const [resourceId, property] = resourcePath.split('.');
                    const resource = resources[resourceId];
                    
                    if (resource && property === 'max') {
                        resource.max += modifier;
                    }
                }
            }
            
            // Log the purchase
            addToLog(`Purchased ${upgrade.name}.`);
            
            // Update displays
            updateResourceDisplay();
            updateUpgradeDisplay();
        }
        
        // Add resource
        function addResource(resourceId, amount) {
            const resource = resources[resourceId];
            if (!resource) return false;
            
            const newValue = resource.value + amount;
            resource.value = Math.min(newValue, resource.max);
            
            updateResourceDisplay();
            updateUpgradeDisplay();
            
            return true;
        }
        
        // Subtract resource
        function subtractResource(resourceId, amount) {
            const resource = resources[resourceId];
            if (!resource || resource.value < amount) return false;
            
            resource.value -= amount;
            
            updateResourceDisplay();
            updateUpgradeDisplay();
            
            return true;
        }
        
        // Check requirement
        function checkRequirement(requirementStr) {
            // Handle resource requirements like "resources.gold>=10"
            if (requirementStr.startsWith('resources.')) {
                const parts = requirementStr.split('>=');
                if (parts.length === 2) {
                    const resourceId = parts[0].split('.')[1];
                    const minValue = parseInt(parts[1]);
                    
                    const resource = resources[resourceId];
                    return resource && resource.value >= minValue;
                }
            }
            
            // Default to true for other requirements
            return true;
        }
        
        // Add to log
        function addToLog(message) {
            const log = document.getElementById('action-log');
            const entry = document.createElement('p');
            entry.textContent = message;
            log.appendChild(entry);
            
            // Auto-scroll to bottom
            log.scrollTop = log.scrollHeight;
        }
        
        // Helper function to capitalize
        function capitalize(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>